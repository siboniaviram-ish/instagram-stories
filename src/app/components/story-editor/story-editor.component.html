<div class="editor-overlay">
  <!-- Header -->
  <div class="editor-header">
    <button class="back-btn" (click)="cancel()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    <div class="header-tools">
      @if (mediaSrc) {
        <!-- Text -->
        <button class="tool-btn" (click)="addText()" title="Add text">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M4 7V4h16v3M9 20h6M12 4v16"/>
          </svg>
        </button>
        <!-- Emoji -->
        <button class="tool-btn" (click)="toggleEmojiPicker()" title="Add emoji">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
            <line x1="9" y1="9" x2="9.01" y2="9"/>
            <line x1="15" y1="9" x2="15.01" y2="9"/>
          </svg>
        </button>
        <!-- Location -->
        <button class="tool-btn" (click)="openLocationPicker()" title="Add location">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
        </button>
        <!-- Hashtag -->
        <button class="tool-btn" (click)="openHashtagInput()" title="Add hashtag">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <line x1="4" y1="9" x2="20" y2="9"/>
            <line x1="4" y1="15" x2="20" y2="15"/>
            <line x1="10" y1="3" x2="8" y2="21"/>
            <line x1="16" y1="3" x2="14" y2="21"/>
          </svg>
        </button>
        <!-- Mention -->
        <button class="tool-btn" (click)="openMentionInput()" title="Tag someone">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <circle cx="12" cy="12" r="4"/>
            <path d="M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-3.92 7.94"/>
          </svg>
        </button>
        <!-- Music -->
        <button class="tool-btn" (click)="openMusicPicker()" title="Add music">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M9 18V5l12-2v13"/>
            <circle cx="6" cy="18" r="3"/>
            <circle cx="18" cy="16" r="3"/>
          </svg>
        </button>
      }
    </div>
    <button class="share-btn" [disabled]="!mediaSrc" (click)="post()">Share</button>
  </div>

  <!-- Text input modal -->
  @if (showTextInput) {
    <div class="text-input-overlay">
      <input
        class="text-input-field"
        [(ngModel)]="newText"
        placeholder="Type your text..."
        autofocus
        (keydown.enter)="confirmText()"
      />
      <div class="text-input-actions">
        <button class="text-cancel" (click)="cancelText()">Cancel</button>
        <button class="text-confirm" (click)="confirmText()">Done</button>
      </div>
    </div>
  }

  <!-- Emoji picker -->
  @if (showEmojiPicker) {
    <div class="emoji-picker">
      @for (emoji of emojis; track emoji) {
        <button class="emoji-btn" (click)="addEmoji(emoji)">{{ emoji }}</button>
      }
    </div>
  }

  <!-- Location picker -->
  @if (activePrompt === 'location') {
    <div class="sticker-panel">
      <div class="sticker-panel-header">
        <span class="sticker-panel-title">üìç Add Location</span>
        <button class="sticker-close" (click)="cancelPrompt()">‚úï</button>
      </div>
      <div class="sticker-search">
        <input
          [(ngModel)]="promptInput"
          placeholder="Search location..."
          autofocus
          (keydown.enter)="confirmPromptAsLocation()"
        />
      </div>
      <div class="sticker-list">
        @for (loc of filteredLocations; track loc) {
          <button class="sticker-list-item" (click)="selectLocation(loc)">
            <span class="sticker-icon">üìç</span>
            <span>{{ loc }}</span>
          </button>
        }
      </div>
    </div>
  }

  <!-- Hashtag input -->
  @if (activePrompt === 'hashtag') {
    <div class="sticker-panel">
      <div class="sticker-panel-header">
        <span class="sticker-panel-title"># Hashtag</span>
        <button class="sticker-close" (click)="cancelPrompt()">‚úï</button>
      </div>
      <div class="sticker-search">
        <input
          [(ngModel)]="promptInput"
          placeholder="Type a hashtag..."
          autofocus
          (keydown.enter)="confirmHashtag()"
        />
      </div>
      <div class="sticker-actions">
        <button class="sticker-confirm" (click)="confirmHashtag()">Add #{{ promptInput || '...' }}</button>
      </div>
    </div>
  }

  <!-- Mention input -->
  @if (activePrompt === 'mention') {
    <div class="sticker-panel">
      <div class="sticker-panel-header">
        <span class="sticker-panel-title">@ Tag Someone</span>
        <button class="sticker-close" (click)="cancelPrompt()">‚úï</button>
      </div>
      <div class="sticker-search">
        <input
          [(ngModel)]="promptInput"
          placeholder="Type a username..."
          autofocus
          (keydown.enter)="confirmMention()"
        />
      </div>
      <div class="sticker-actions">
        <button class="sticker-confirm" (click)="confirmMention()">Tag @{{ promptInput || '...' }}</button>
      </div>
    </div>
  }

  <!-- Music picker -->
  @if (activePrompt === 'music') {
    <div class="sticker-panel">
      <div class="sticker-panel-header">
        <span class="sticker-panel-title">üéµ Add Music</span>
        <button class="sticker-close" (click)="cancelPrompt()">‚úï</button>
      </div>
      <div class="sticker-search">
        <input
          [(ngModel)]="promptInput"
          placeholder="Search songs..."
          autofocus
        />
      </div>
      <div class="sticker-list">
        @for (song of filteredMusic; track song.title) {
          <button class="sticker-list-item" (click)="selectMusic(song.title, song.artist)">
            <span class="sticker-icon">üéµ</span>
            <div class="song-info">
              <span class="song-title">{{ song.title }}</span>
              <span class="song-artist">{{ song.artist }}</span>
            </div>
          </button>
        }
      </div>
    </div>
  }

  <!-- Preview area -->
  <div class="editor-preview">
    @if (mediaSrc) {
      @if (mediaType === 'video') {
        <video
          [src]="mediaSrc"
          [ngStyle]="{'filter': combinedFilter}"
          autoplay
          muted
          loop
          playsinline
        ></video>
      } @else {
        <img
          [src]="mediaSrc"
          [ngStyle]="{'filter': combinedFilter}"
          alt="Preview"
        />
      }

      <!-- Text/emoji/sticker overlays -->
      @for (overlay of overlays; track overlay.id) {
        <div
          class="text-overlay"
          [class.sticker-location]="overlay.style === 'location'"
          [class.sticker-hashtag]="overlay.style === 'hashtag'"
          [class.sticker-mention]="overlay.style === 'mention'"
          [class.sticker-music]="overlay.style === 'music'"
          [style.left.px]="overlay.x"
          [style.top.px]="overlay.y"
          [style.fontSize.px]="overlay.fontSize"
          (mousedown)="onOverlayDragStart($event, overlay)"
          (touchstart)="onOverlayTouchStart($event, overlay)"
        >{{ overlay.text }}</div>
      }

      <!-- Filter name toast -->
      @if (filterToastVisible) {
        <div class="filter-toast">{{ filterToastName }}</div>
      }
    } @else {
      <div class="upload-prompt" (click)="triggerUpload()">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21 15 16 10 5 21"/>
        </svg>
        <span>Tap to upload photo or video</span>
      </div>
    }
  </div>

  <!-- Hidden file input -->
  <input
    #fileInput
    type="file"
    accept="image/*,video/*"
    style="display: none"
    (change)="onFileSelected($event)"
  />

  <!-- Filter strip -->
  @if (mediaSrc) {
    <app-filter-strip
      [mediaSrc]="mediaSrc"
      [isVideo]="mediaType === 'video'"
      (filterSelected)="onFilterSelected($event)"
    />
  }

  <!-- Adjustment sliders -->
  @if (mediaSrc) {
    <app-adjustment-sliders
      (adjustmentChanged)="onAdjustmentChanged($event)"
    />
  }
</div>
